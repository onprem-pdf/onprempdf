#!/bin/bash
set -euo pipefail

# ==========================================================
# DISCLAIMER
# ==========================================================
echo "=========================================================="
echo "PDFGuard is a proprietary PDF rendering engine provided by OnPrem PDF API."
echo "This script will install Apache Tomcat and the PDFGuard application on this system."
echo "It is recommended to run this installer on a dedicated virtual machine or server."
echo "=========================================================="
echo ""

# ==========================================================
# CONFIG
# ==========================================================
APP_NAME="pdfguard"
WAR_URL="https://onprempdf.com/war/pdfguard.war"
WAR_SHA256="08736a33cfa114245d72c3a376920cdfdd8acfa8ce2d262baf9b961924b7712e"


TOMCAT_USER="tomcat"
TOMCAT_GROUP="tomcat"
TOMCAT_DIR="/opt/tomcat"
TOMCAT_VER="9.0.113"

TMP_DIR="/tmp/pdfguard-install"
WAR_LOCAL="${TMP_DIR}/${APP_NAME}.war"
TOMCAT_WEBAPPS="${TOMCAT_DIR}/webapps"
TOMCAT_CONF="${TOMCAT_DIR}/conf"

ADMIN_USER="pdfguard"

log() { echo "[pdfguard] $*"; }

require_root() {
  [[ $EUID -eq 0 ]] || { echo "Bitte als root ausfuehren (sudo ./install.sh)"; exit 1; }
}

# ==========================================================
# START
# ==========================================================
require_root

log "Prepare temp dir"
rm -rf "${TMP_DIR}"
mkdir -p "${TMP_DIR}"

# ==========================================================
# BASE PACKAGES
# ==========================================================
log "Install base packages"
apt update
apt install -y \
  openjdk-17-jre-headless \
  curl ca-certificates tar openssl \
  fontconfig

# ==========================================================
# Tomcat user
# ==========================================================
if ! id -u "$TOMCAT_USER" >/dev/null 2>&1; then
  log "Create Tomcat user"
  useradd -r -m -U -d "$TOMCAT_DIR" -s /usr/sbin/nologin "$TOMCAT_USER"
fi

# ==========================================================
# Tomcat install
# ==========================================================
log "Install Tomcat ${TOMCAT_VER}"
cd /tmp
TARBALL="apache-tomcat-${TOMCAT_VER}.tar.gz"
URL="https://dlcdn.apache.org/tomcat/tomcat-9/v${TOMCAT_VER}/bin/${TARBALL}"


curl -fL "$URL" -o "$TARBALL"

mkdir -p "$TOMCAT_DIR"
rm -rf "${TOMCAT_DIR:?}/"*
tar -xzf "$TARBALL" -C "$TOMCAT_DIR" --strip-components=1

chown -R "${TOMCAT_USER}:${TOMCAT_GROUP}" "$TOMCAT_DIR"
chmod +x "${TOMCAT_DIR}/bin/"*.sh

# ==========================================================
# 
# ==========================================================
log "Create PDFGuard data directory"

PDFGUARD_DATA="/var/lib/pdfguard"

mkdir -p "$PDFGUARD_DATA"
chown "${TOMCAT_USER}:${TOMCAT_GROUP}" "$PDFGUARD_DATA"
chmod 750 "$PDFGUARD_DATA"

# Lite mode = no license file present

# ==========================================================
# Download WAR + deploy
# ==========================================================



# ==========================================================
# systemd service
# ==========================================================
log "Create systemd service for Tomcat"
cat > /etc/systemd/system/pdfguard.service <<EOF
[Unit]
Description=Apache Tomcat 9 (PDFGuard)
After=network.target

[Service]
Type=forking
User=${TOMCAT_USER}
Group=${TOMCAT_GROUP}
Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
Environment="CATALINA_HOME=${TOMCAT_DIR}"
Environment="CATALINA_BASE=${TOMCAT_DIR}"
Environment="CATALINA_PID=${TOMCAT_DIR}/temp/tomcat.pid"
ExecStart=${TOMCAT_DIR}/bin/startup.sh
ExecStop=${TOMCAT_DIR}/bin/shutdown.sh
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload

# ==========================================================
# Generate admin password
# ==========================================================
log "Generate admin credentials"
ADMIN_PASS="$(openssl rand -base64 24)"

# ==========================================================
# Configure Tomcat Basic Auth
# ==========================================================
log "Configure Tomcat users"

cat > "${TOMCAT_CONF}/tomcat-users.xml" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<tomcat-users xmlns="http://tomcat.apache.org/xml"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://tomcat.apache.org/xml tomcat-users.xsd"
              version="1.0">
  <role rolename="pdfguard-admin"/>
  <user username="${ADMIN_USER}" password="${ADMIN_PASS}" roles="pdfguard-admin"/>
</tomcat-users>
EOF

chown ${TOMCAT_USER}:${TOMCAT_GROUP} "${TOMCAT_CONF}/tomcat-users.xml"
chmod 600 "${TOMCAT_CONF}/tomcat-users.xml"

# ==========================================================
# Download WAR + deploy
# ==========================================================
log "Download WAR"
curl -fL "$WAR_URL" -o "$WAR_LOCAL"

log "Verify WAR integrity (SHA-256)"
echo "${WAR_SHA256}  ${WAR_LOCAL}" | sha256sum -c -

systemctl stop pdfguard || true
rm -rf "${TOMCAT_WEBAPPS:?}/${APP_NAME}"*
cp "$WAR_LOCAL" "${TOMCAT_WEBAPPS}/${APP_NAME}.war"
chown "${TOMCAT_USER}:${TOMCAT_GROUP}" "${TOMCAT_WEBAPPS}/${APP_NAME}.war"

# ==========================================================
# Enable & start Tomcat
# ==========================================================
log "Enable services"
systemctl enable pdfguard
systemctl start pdfguard

# ==========================================================
# Done
# ==========================================================
IP="$(hostname -I | awk '{print $1}')"
echo ""
echo "=========================================================="
echo "Installation finished!"
echo ""
echo "PDFGuard API:"
echo "http://${IP}:8080/pdfguard/api/v1/render"
echo ""
echo "Admin-GUI:"
echo "http://${IP}:8080/pdfguard/"
echo ""
echo "Admin Login:"
echo "Benutzer: ${ADMIN_USER}"
echo "Passwort: ${ADMIN_PASS}"
echo ""
echo "Please save this password now.It will not be shown again."
echo "=========================================================="
